<!doctype html><html lang=en><head><title>Double Loop TDD: Building My Blog Engine the Right Way (part 2) · cekrem.github.io
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Christian Ekrem"><meta name=description content="How I'm using Double Loop TDD to build my blog engine"><meta name=keywords content="developer,personal"><meta name=fediverse:creator content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cekrem.github.io/images/featured-with-margins.png"><meta name=twitter:title content="Double Loop TDD: Building My Blog Engine the Right Way (part 2)"><meta name=twitter:description content="How I'm using Double Loop TDD to build my blog engine"><meta property="og:url" content="https://cekrem.github.io/posts/double-loop-tdd-blog-engine-pt2/"><meta property="og:site_name" content="cekrem.github.io"><meta property="og:title" content="Double Loop TDD: Building My Blog Engine the Right Way (part 2)"><meta property="og:description" content="How I'm using Double Loop TDD to build my blog engine"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-18T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-18T00:00:00+00:00"><meta property="article:tag" content="TDD"><meta property="article:tag" content="Kotlin"><meta property="article:tag" content="Clean Architecture"><meta property="article:tag" content="Testing"><meta property="article:tag" content="Blog Engine"><meta property="og:image" content="https://cekrem.github.io/images/featured-with-margins.png"><link rel=canonical href=https://cekrem.github.io/posts/double-loop-tdd-blog-engine-pt2/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-light"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://cekrem.github.io/>cekrem.github.io
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/hire/>Hire me?</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/books-i-think-software-engineers-should-read>Recommended Books</a></li><li class=navigation-item><a class=navigation-link href=https://creators.spotify.com/pod/show/disippel>Podcast (🇳🇴)</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://cekrem.github.io/posts/double-loop-tdd-blog-engine-pt2/>Double Loop TDD: Building My Blog Engine the Right Way (part 2)</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2025-02-18T00:00:00Z>February 18, 2025
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
5-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/tdd/>TDD</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/kotlin/>Kotlin</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/clean-architecture/>Clean Architecture</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/testing/>Testing</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/blog-engine/>Blog Engine</a></span></div></div></header><div class=post-content><h2 id=from-hugo-to-kotlin-the-journey-continues>From Hugo to Kotlin: The Journey Continues
<a class=heading-link href=#from-hugo-to-kotlin-the-journey-continues><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>In my <a href=/posts/replacing-hugo-with-kotlin-clean-architecture>previous post</a>, embarked on a bold and ambitious journey to replace Hugo with a custom Kotlin-based blog engine built using Clean Architecture principles (to the letter!). Today, I want to dive deeper into the development process, specifically how I&rsquo;m using <strong>Double Loop TDD</strong> to ensure the quality and maintainability of the system. Again, I&rsquo;m trying to go all-in, basically to see how far is too far, and to learn and explore.</p><h2 id=what-is-double-loop-tdd>What is Double Loop TDD?
<a class=heading-link href=#what-is-double-loop-tdd><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><a href=https://khalilstemmler.com/articles/test-driven-development/introduction-to-tdd/#Double-Loop-TDD class=external-link target=_blank rel=noopener>Double Loop TDD</a> is an approach that combines two testing cycles:</p><ol><li><strong>Outer Loop (Acceptance Tests)</strong>: High-level tests that verify the system&rsquo;s behavior from the user&rsquo;s perspective</li><li><strong>Inner Loop (Unit Tests)</strong>: Low-level tests that verify the implementation details of individual components</li></ol><p>The key idea is to write an acceptance test first, watch it fail, then use unit tests to drive the implementation that makes the acceptance test pass. The unit tests will traverse the layers of the clean architecture, starting from the domain layer and working their way down to the nitty-gritty infrastructure layer, until they all - along with the acceptance test - pass. When done, you&rsquo;ll ideally have a system that is both robust and easy to maintain (or that&rsquo;s the plan, at least). With 100% test coverage, of course.</p><p><img src=https://khalilstemmler.com/img/blog/tdd/intro/double-loop-tdd.svg alt="&ldquo;Double Loop TDD Illustration&rdquo;"></p><blockquote><p>Image borrowed from <a href=https://khalilstemmler.com/ class=external-link target=_blank rel=noopener>khalilstemmler.com</a>, in return I guess it&rsquo;s only fair I recommend his <a href=https://solidbook.io/ class=external-link target=_blank rel=noopener>Solid Book</a></p></blockquote><h2 id=the-current-state-of-the-blog-engine>The Current State of the Blog Engine
<a class=heading-link href=#the-current-state-of-the-blog-engine><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The source code for this project can be found <a href=https://github.com/cekrem/clean-blog/tree/v0.2 class=external-link target=_blank rel=noopener>here</a>. Please note that I&rsquo;m right in the middle of development as I&rsquo;m writing this, so this project is by no means finished. Here&rsquo;s where I&rsquo;m at in the development process:</p><ol><li><strong>Acceptance Tests</strong>: I&rsquo;ve written the <code>ServeMarkdownBlogPostFeatureTest</code> that verifies the end-to-end behavior of serving markdown posts as HTML</li><li><strong>Domain Layer</strong>: Complete with tests</li><li><strong>Application Layer</strong>: Complete with tests</li><li><strong>Interface Adapter Layer</strong>: This layer is quite thin, abstract and empty for now, nothing really to test. I&rsquo;m thinking about moving the controller to this layer, and return a generic type rather than using the ktor-specific <code>call.respond()</code> that put it in the infrastructure layer in the first place. WIP indeed!</li><li><strong>Infrastructure Layer</strong>: Markdown parsing is working, but HTML transformation needs work, or in more general terms: the input device (markdown to domain model) is working, but the output device (domain model to HTML) is not working yet.</li></ol><p>I&rsquo;m coming to like this approach more than I&rsquo;d planned. It&rsquo;s forcing me to think about the system in a more holistic way, and to consider the interactions between the layers. Strangely it&rsquo;s also forcing me to focus more on the individual components, and testing them in isolation (which wouldn&rsquo;t even be possible without this die-hard Clean Architecture setup).</p><h2 id=the-acceptance-test-in-action>The Acceptance Test in Action
<a class=heading-link href=#the-acceptance-test-in-action><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Here&rsquo;s a snippet of the acceptance test that&rsquo;s driving the development:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=font-weight:700>class</span> <span style=font-weight:700>ServeMarkdownBlogPostFeatureTest</span> : FeatureAcceptanceTest() {
</span></span><span style=display:flex><span>    @Test
</span></span><span style=display:flex><span>    <span style=font-weight:700>fun</span> `should convert and serve markdown blog posts as properly formatted HTML pages`() =
</span></span><span style=display:flex><span>        runTest {
</span></span><span style=display:flex><span>            <span style=font-weight:700>TestFixtures</span>.blogPosts.forEach { post -&gt;
</span></span><span style=display:flex><span>                <span style=font-style:italic>// Given a blog post exists
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>                testApplication.givenBlogPost(
</span></span><span style=display:flex><span>                    slug = post,
</span></span><span style=display:flex><span>                    content = <span style=font-weight:700>TestFixtures</span>.readMarkdownPost(post),
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=font-style:italic>// When requesting the blog post
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>                <span style=font-weight:700>val</span> response = testClient.<span style=font-weight:700>get</span>(<span style=font-style:italic>&#34;</span><span style=font-weight:700;font-style:italic>${testApplication.baseUrl}</span><span style=font-style:italic>/posts/</span><span style=font-weight:700;font-style:italic>$post</span><span style=font-style:italic>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=font-style:italic>// Then it should return properly formatted HTML
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>                assertEquals(<span style=font-weight:700>HttpStatusCode</span>.OK, response.status)
</span></span><span style=display:flex><span>                assertEquals(
</span></span><span style=display:flex><span>                    <span style=font-weight:700>ContentType</span>.<span style=font-weight:700>Text</span>.<span style=font-weight:700>Html</span>.withCharset(<span style=font-weight:700>Charsets</span>.UTF_8),
</span></span><span style=display:flex><span>                    response.contentType(),
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                assertEquals(<span style=font-weight:700>TestFixtures</span>.readHtmlFixture(post), response.bodyAsText())
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The test uses markdown and HTML fixtures to verify that this markdown:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown><span style=display:flex><span>---
</span></span><span style=display:flex><span>title: Hello, World!
</span></span><span style=display:flex><span>description: This is the description
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>## Basic content
</span></span></span><span style=display:flex><span><span style=font-weight:700></span>
</span></span><span style=display:flex><span>This is my first blog post. Welcome to my blog!
</span></span></code></pre></div><p>will be transformed into this HTML:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span>&lt;!doctype html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=font-weight:700>html</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=font-weight:700>head</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=font-weight:700>title</span>&gt;Hello, World!&lt;/<span style=font-weight:700>title</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=font-weight:700>meta</span> charset=<span style=font-style:italic>&#34;utf-8&#34;</span> /&gt;
</span></span><span style=display:flex><span>    &lt;<span style=font-weight:700>meta</span> content=<span style=font-style:italic>&#34;This is the description&#34;</span> name=<span style=font-style:italic>&#34;description&#34;</span> /&gt;
</span></span><span style=display:flex><span>  &lt;/<span style=font-weight:700>head</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=font-weight:700>body</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=font-weight:700>h1</span>&gt;Hello, World!&lt;/<span style=font-weight:700>h1</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=font-weight:700>h2</span>&gt;Basic content&lt;/<span style=font-weight:700>h2</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=font-weight:700>p</span>&gt;This is my first blog post. Welcome to my blog!&lt;/<span style=font-weight:700>p</span>&gt;
</span></span><span style=display:flex><span>  &lt;/<span style=font-weight:700>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=font-weight:700>html</span>&gt;
</span></span></code></pre></div><p>(The actual fixtures contain a bit more complex content, I simplified it a bit in this post to avoid spamming with long code blocks.)</p><p>For now, it&rsquo;s not nearly there. But I&rsquo;m getting closer, one unit test at a time. Which is a lot better than just coding blindly until it happens to work (good luck refactoring the mess you&rsquo;ve made without breaking stuff with that approach).</p><h2 id=next-steps>Next Steps
<a class=heading-link href=#next-steps><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ol start=0><li>(<strong>Get layers in order?</strong> Try again to move the controller to the adapter layer, it probably belongs there)</li><li><strong>Write Unit Remaining Unit Tests</strong>: Let&rsquo;s get 100% coverage on that infra layer too!</li><li><strong>Implement Transformation</strong>: Make the output device (domain model to HTML) work</li><li><strong>Refactor</strong>: Clean up the code while keeping all tests passing</li><li><strong>Extend Features</strong>: Add support for more markdown elements and custom templates</li></ol><h2 id=lessons-learned-so-far>Lessons Learned So Far
<a class=heading-link href=#lessons-learned-so-far><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ol><li><strong>Acceptance Tests are Powerful</strong>: Having clear acceptance criteria makes it easier to focus development efforts</li><li><strong>Layered Testing Works</strong>: Testing at different levels (acceptance, unit) provides confidence in the system</li><li><strong>Using Double Loop TDD makes testing efforts a lot more structured and predictable</strong>: Both progress and path becomes very transparent and measurable</li><li><strong>Infrastructure is Tricky</strong>: The infrastructure layer often requires more attention than expected – it&rsquo;s a great idea to keep it in its own layer. Clean architecture makes sense!</li></ol><p>Stay tuned for the next post where I&rsquo;ll share how I tackled the HTML transformation challenge and the lessons learned along the way! Or how I gave up on it all and went back to Hugo, haha. We&rsquo;ll see.</p><blockquote><p><strong>Pro tip</strong>: When working with Double Loop TDD, focus on one failing unit test at a time. It&rsquo;s tempting to try to solve everything at once, but incremental progress leads to better results.</p></blockquote></div><footer></footer></article></section></div><script type=text/javascript src=https://testimonial.to/js/iframeResizer.min.js></script><style>form{display:flex;justify-content:center}</style><form action="https://api.follow.it/subscription-form/SDRVMUk2VmsySENBNk94RDNKNDFnS3NmWlQ5a3gxejNIeUlJWHl3QjdqNnRHdENkaXp5aXZhZlFvcGtzcEZ3K0o5TFVRdSt2WWM5RWRsWmZwWVhNUS9PZjJqMWZ3aHBwZUhjT1ZpWXBGRkdZOWtIcGhYQkJkSkE4QTQ1eHl5YkF8RTZHTExQOWFrN1pFY1F0RzZ5c3pVN2I1QTI1YXNtMjZiYllLU25zQkJ3bz0=/8" method=post><input type=email name=email required placeholder=Email spellcheck=false>
<button type=submit>Subscribe</button></form><div id=testemonials class=container style="background:#fff!important;clip-path:inset(0 0 90px 0);padding:24px;border-radius:24px;opacity:0;max-height:0;transition:opacity 1s,max-height 1s"><iframe id=testimonialto-carousel-christian-ekrem-tag-all-light src="https://embed-v2.testimonial.to/carousel/all/christian-ekrem?theme=light&autoplay=off&showmore=on&one-row=on&hideDate=off&same-height=off&tag=all&arrowColor=9BA9B4" frameborder=0 scrolling=no width=100%></iframe></div><script type=text/javascript>location.pathname in{"":!0,"/":!0,"/hire/":!0,"/hire":!0}&&setTimeout(()=>{iFrameResize({log:!1,checkOrigin:!1},"#testimonialto-carousel-christian-ekrem-tag-all-light");const e=document.getElementById("testemonials");e.style.display="block",e.style.opacity=1,e.style.maxHeight="600px"},1e3)</script><footer class=footer><section class=container>© 2021 - 2025 Christian Ekrem
<script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-emoji=🍺 data-id=cekrem data-description="Support me on Buy me a coffee!" data-message data-color=#ddd data-position=Right data-x_margin=18 data-y_margin=18></script></section><script src=https://formspree.io/js/formbutton-v1.min.js defer></script></footer><script>document.head.innerHTML+=`<meta http-equiv="Content-Security-Policy" content="script-src-elem 'self' https://sdk.feedback.one http://gc.zgo.at; connect-src 'self' https://api.feedback.one ws://localhost:1313; frame-ancestors 'self' http://cekrem.github.io https://cekrem.github.io https://form.feedback.one;">
`</script><script src=https://sdk.feedback.one/v0/core.min.js data-project-id=019589e0-c6fb-7b80-b6ae-dffbfbb11f72 defer></script></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script data-goatcounter=https://cekrem.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>