<!doctype html><html lang=en><head><title>Reducing Android Build Times on Azure by 80% using a Virtual Machine Scale Set (VMSS) Â· cekrem.github.io</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Christian Ekrem"><meta name=description content="
A VMSS is, put as plainly as possible, a cluster of VMs that are scaled on-demand or manually.


  Context
  
    
    Link to heading
  

The Vipps App â€“ until recently â€“ took about 45 minutes to build on A$ure Azure. With a weekly release schedule, that might not sound like a huge dealbreaker, but since we&rsquo;re using a &ldquo;feature branch&rdquo; approach to how we do git (ie no develop branch; master should always be deployable-ish), we don&rsquo;t allow merging anything to master without a successful cloud build. Waiting for code review is hard to avoid, but additionally waiting for slow builds is just wrong. It&rsquo;s not easy for our internal testers to check out what we&rsquo;re doing either, they too are kept waiting. Suffice to say, the pain has been real. Personally, coming from a Golang background (where builds happen at the speed of your monitor&rsquo;s refresh rate), this kind of wrecked my soul on a daily basis. Granted, Android builds are more complicated (I&rsquo;m looking at you, Java ecosystem!) than single-binary Golang builds, but 40+ minutes for one app build is too slow nonetheless."><meta name=keywords content="developer,personal"><meta name=fediverse:creator content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cekrem.github.io/images/featured-with-margins.png"><meta name=twitter:title content="Reducing Android Build Times on Azure by 80% using a Virtual Machine Scale Set (VMSS)"><meta name=twitter:description content="A VMSS is, put as plainly as possible, a cluster of VMs that are scaled on-demand or manually.
Context Link to heading The Vipps App â€“ until recently â€“ took about 45 minutes to build on A$ure Azure. With a weekly release schedule, that might not sound like a huge dealbreaker, but since weâ€™re using a â€œfeature branchâ€ approach to how we do git (ie no develop branch; master should always be deployable-ish), we donâ€™t allow merging anything to master without a successful cloud build. Waiting for code review is hard to avoid, but additionally waiting for slow builds is just wrong. Itâ€™s not easy for our internal testers to check out what weâ€™re doing either, they too are kept waiting. Suffice to say, the pain has been real. Personally, coming from a Golang background (where builds happen at the speed of your monitorâ€™s refresh rate), this kind of wrecked my soul on a daily basis. Granted, Android builds are more complicated (Iâ€™m looking at you, Java ecosystem!) than single-binary Golang builds, but 40+ minutes for one app build is too slow nonetheless."><meta property="og:url" content="https://cekrem.github.io/posts/reducing-android-build-times-on-azure-by-80/"><meta property="og:site_name" content="cekrem.github.io"><meta property="og:title" content="Reducing Android Build Times on Azure by 80% using a Virtual Machine Scale Set (VMSS)"><meta property="og:description" content="A VMSS is, put as plainly as possible, a cluster of VMs that are scaled on-demand or manually.
Context Link to heading The Vipps App â€“ until recently â€“ took about 45 minutes to build on A$ure Azure. With a weekly release schedule, that might not sound like a huge dealbreaker, but since weâ€™re using a â€œfeature branchâ€ approach to how we do git (ie no develop branch; master should always be deployable-ish), we donâ€™t allow merging anything to master without a successful cloud build. Waiting for code review is hard to avoid, but additionally waiting for slow builds is just wrong. Itâ€™s not easy for our internal testers to check out what weâ€™re doing either, they too are kept waiting. Suffice to say, the pain has been real. Personally, coming from a Golang background (where builds happen at the speed of your monitorâ€™s refresh rate), this kind of wrecked my soul on a daily basis. Granted, Android builds are more complicated (Iâ€™m looking at you, Java ecosystem!) than single-binary Golang builds, but 40+ minutes for one app build is too slow nonetheless."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-04T12:00:21+02:00"><meta property="article:modified_time" content="2022-05-04T12:00:21+02:00"><meta property="article:tag" content="Vipps"><meta property="article:tag" content="Azure"><meta property="article:tag" content="Cloud"><meta property="article:tag" content="Build"><meta property="article:tag" content="Gradle"><meta property="article:tag" content="Vmss"><meta property="og:image" content="https://cekrem.github.io/images/featured-with-margins.png"><link rel=canonical href=https://cekrem.github.io/posts/reducing-android-build-times-on-azure-by-80/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.f63b17f16aa5dbf557dd08e6806b0b477d5e6d8f2af64807e14512a12dd2ccaa.css integrity="sha256-9jsX8Wql2/VX3QjmgGsLR31ebY8q9kgH4UUSoS3SzKo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.be284be20943b01514c49cbe3832fe8cc215513c0e5962b1d349102cf16f2c25.css integrity="sha256-vihL4glDsBUUxJy+ODL+jMIVUTwOWWKx00kQLPFvLCU=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://cekrem.github.io/>cekrem.github.io
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/books-i-think-software-engineers-should-read>Recommended Books</a></li><li class=navigation-item><a class=navigation-link href=https://creators.spotify.com/pod/show/disippel>Podcast (ðŸ‡³ðŸ‡´)</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://cekrem.github.io/posts/reducing-android-build-times-on-azure-by-80/>Reducing Android Build Times on Azure by 80% using a Virtual Machine Scale Set (VMSS)</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2022-05-04T12:00:21+02:00>May 4, 2022
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
7-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/vipps/>Vipps</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/azure/>Azure</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/cloud/>Cloud</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/build/>Build</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/gradle/>Gradle</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/vmss/>Vmss</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/virtual-machine-scale-set/>Virtual Machine Scale Set</a></span></div></div></header><div class=post-content><blockquote><p>A VMSS is, put as plainly as possible, a cluster of VMs that are scaled on-demand or manually.</p></blockquote><h2 id=context>Context
<a class=heading-link href=#context><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The <a href="https://play.google.com/store/apps/details?id=no.dnb.vipps&amp;hl=no&amp;gl=US" class=external-link target=_blank rel=noopener>Vipps App</a> â€“ until recently â€“ took about 45 minutes to build on <del>A$ure</del> Azure. With a weekly release schedule, that might not sound like a huge dealbreaker, but since we&rsquo;re using a &ldquo;feature branch&rdquo; approach to how we do <code>git</code> (ie no <code>develop</code> branch; <code>master</code> should always be deployable-ish), we don&rsquo;t allow merging <em>anything</em> to <code>master</code> without a successful cloud build. Waiting for code review is hard to avoid, but additionally waiting for slow builds is just wrong. It&rsquo;s not easy for our internal testers to check out what we&rsquo;re doing either, they <em>too</em> are kept waiting. Suffice to say, the pain has been real. Personally, coming from a Golang background (where builds happen at the speed of your monitor&rsquo;s refresh rate), this kind of wrecked my soul on a daily basis. Granted, Android builds are more complicated (I&rsquo;m looking at you, Java ecosystem!) than single-binary Golang builds, but 40+ minutes for one app build is too slow nonetheless.</p><p>But like quite a few other companies dealing with payments and sensitive data, we&rsquo;re stuck on Azure. I guess if you can&rsquo;t do better than Azure, you can do better <em>on</em> Azure.</p><p><img src=old-build.png alt="old build"></p><h2 id=what-sparked-us-to-make-a-change>What sparked us to make a change?
<a class=heading-link href=#what-sparked-us-to-make-a-change><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>TL;DR: The M1 chip:</p><p><img src=m1-build.png alt="local m1 build"></p><p>I think we&rsquo;ve grown a bit accustomed to builds just being slow. Even locally on quite high-end hardware, we usually passed the 10-minute mark. But when we started using M1 MacBook pro&rsquo;s, we were once again reminded that builds don&rsquo;t <em>have</em> to be slow, and the huge difference between local and cloud builds was once again very apparent. Initially I was hoping Azure might support macOS agents running on M1 hardware (which I&rsquo;m sure they will eventually), but even without that I had to try <em>something</em>.</p><h2 id=a-virtual-machine-what-now>A Virtual machine what-now?
<a class=heading-link href=#a-virtual-machine-what-now><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We run most our Vipps builds on generic &ldquo;Hosted agents&rdquo;, either running Ubuntu LTS or macOS. These agents come off the shelf pre-configured and pre-provisioned, with just about everything you need and then some. And, apparently, they&rsquo;re a lot slower than setting up your own stuff. One alternative is utilizing a <a href=https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/overview class=external-link target=_blank rel=noopener><em>Virtual Machine Scale Set</em> (VMSS)</a>. This &ldquo;Scale Set&rdquo; is still hosted on Azure, but we&rsquo;re suddenly responsible for config and provisioning of the agents. A VMSS is, put as plainly as possible, a cluster of VMs that are scaled on-demand or manually. Our lead Android architect brought this option to my attention and suggested giving it a shot. Should be easy, right?</p><h2 id=here-be-dragons-or--what-sounds-like-a-breeze-but-really-isnt-in-azure-land>Here be dragons, or â€“ What sounds like a breeze, but really isn&rsquo;t in Azure land
<a class=heading-link href=#here-be-dragons-or--what-sounds-like-a-breeze-but-really-isnt-in-azure-land><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><h4 id=choosing-which-vm-to-use>Choosing which VM to use
<a class=heading-link href=#choosing-which-vm-to-use><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>A lesson learned early in Azure dealings is that <strong>disks are usually the bottleneck of everything</strong>. On VMSSs you have 4 options</p><ul><li>Standard HDD: unthinkably slow</li><li>Premium SSD: still way too slow, and I suspect the main reason generic hosted agents are so slow</li><li><a href=https://docs.microsoft.com/en-us/azure/virtual-machines/ephemeral-os-disks class=external-link target=_blank rel=noopener>Ephemeral HDD</a> as &ldquo;temp/resource disk&rdquo;: faster, but not by any means fast</li><li>Ephemeral HDD as &ldquo;OS cache disk&rdquo;: as fast as it gets on Azure, which is not very fast but not ridiculously slow either. <strong>This is what you want!</strong></li></ul><p>An ephemeral disk is an actual disk physically mounted on the same hardware as the VM, which makes it a lot faster than any other disk accessed remotely. It&rsquo;s not entirely clear to me what the <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/ephemeral-os-disks class=external-link target=_blank rel=noopener>placement of the ephemeral disk</a> actually means, but there&rsquo;s a huge performance difference. I&rsquo;m not sure why one would ever choose temp/resource over OS cache Â¯\<em>(ãƒ„)</em>/Â¯</p><p>The next step is to find a VM that actually <em>supports</em> the &ldquo;right&rdquo; ephemeral placement, and after some vigorous trial and error we decided on the <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/ddv4-ddsv4-series class=external-link target=_blank rel=noopener>Standard_D16ds_v4</a>. It turns out 16 cores and 64GiB RAM is all you need for Azure to build something about 5 times slower than your laptop :D</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-env data-lang=env><span style=display:flex><span><span style=color:#78787e># Insane RAM usage? Yes, please</span>
</span></span><span style=display:flex><span>org.gradle.jvmargs<span style=color:#ff6ac1>=</span>-Xms16g -Xmx48g -XX:+UseParallelGC
</span></span><span style=display:flex><span>org.gradle.caching<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>true</span>
</span></span><span style=display:flex><span>org.gradle.parallel<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>true</span>
</span></span></code></pre></div><p>A medium+ spec&rsquo;ed VM with an ephemeral disk is faster than most top spec&rsquo;ed Ã¼ber pricey tiers. I should charge you for that advice, given what I&rsquo;ve gone through to find out. But I won&rsquo;t.</p><h4 id=connecting-azure-devops-to-your-new-vmss>Connecting Azure DevOps to your new VMSS
<a class=heading-link href=#connecting-azure-devops-to-your-new-vmss><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>After creating your scale set, you have to connect it to your build pipeline. You can try to do this from the Azure portal or the <code>az</code> CLI, but I think it&rsquo;s actually impossible. The &ldquo;right&rdquo; way is to register a new Build Agent from DevOps.</p><p><img src=add-agent-pool.png alt="Add agent pool from Azure DevOps"></p><h4 id=finding-out-which-permissions-you-need-to-make-said-connection>Finding out which permissions you need to make said connection
<a class=heading-link href=#finding-out-which-permissions-you-need-to-make-said-connection><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>TL;DR: The &ldquo;Application Developer&rdquo; AD role is key, and must often be activated via PIM. Blessed are those who have never heard of these things.</p><h4 id=getting-to-know-what-software-already-exists-on-your-new-vms>Getting to know what software already exists on your new VMs
<a class=heading-link href=#getting-to-know-what-software-already-exists-on-your-new-vms><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>Well, not <code>unzip</code>, for starters. And speaking of software, Ubuntu 20LTS is basically broken beyond repair on Azure. 18LTS is better.</p><h4 id=figuring-out-why-how-azure-has-broken-said-software-like-apt>Figuring out <del>why</del> how Azure has broken said software (like <code>apt</code>)
<a class=heading-link href=#figuring-out-why-how-azure-has-broken-said-software-like-apt><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>The main gotcha here (besides not using Ubuntu 20) is that Azure has their own azurized <code>/etc/apt/sources.list</code> that works about 30% of the time. Be sure to fix that in your provisioning script!</p><h4 id=provisioning-your-vms-with-what-you-need-to-avoid-downloading-java-android-sdk--for-each-build>Provisioning your VMs with what you need (to avoid downloading Java, Android SDK ++ for each build)
<a class=heading-link href=#provisioning-your-vms-with-what-you-need-to-avoid-downloading-java-android-sdk--for-each-build><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>There are whispers and rumors of <a href=https://cloudinit.readthedocs.io/en/latest/ class=external-link target=_blank rel=noopener>cloudinit</a> and a few other approaches, but in practice you&rsquo;re pretty much running blind going most routes. No logging, no feedback, no sense of &ldquo;did this run or not?&rdquo;. Adding a custom script extension kind of works, though. In order to load it from an external location and not an unstable azure blob, you need to add it using <code>az</code>, not the portal:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>az vmss extension set -g [resource-group] --vmss-name [vmss-name] --name customScript --publisher Microsoft.Azure.Extensions --protected-settings &#39;{&#34;fileUris&#34;:[&#34;https://example.com/setup.sh&#34;],&#34;commmand&#34;: &#34;bash setup.sh&#34; }&#39;
</span></span></code></pre></div><p>BUT, don&rsquo;t ever try to just change that script, or even change the script and re-run the above command. You risk Azure caching <em>half the script</em>(!!!) and essentially running half of the old and half of the new version. So be sure to change file name on each iteration. I&rsquo;m serious.</p><p>Our <code>setup.sh</code> looks like this:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#78787e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>
</span></span><span style=display:flex><span><span style=color:#78787e># prepare for bashttle</span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>set</span> -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#78787e># let&#39;s do all logging to a file on the VM, and print it from the build pipeline (where we can actually see output...) # this ensures our builds have the provisioning debug log recorded in the build pipeline on DevOps</span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>logFile</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;/var/log/debug&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>currentUser</span><span style=color:#ff6ac1>=</span><span style=color:#ff6ac1>$(</span>whoami<span style=color:#ff6ac1>)</span>
</span></span><span style=display:flex><span>sudo touch <span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>sudo chown <span style=color:#5af78e>&#34;</span><span style=color:#ff5c57>$currentUser</span><span style=color:#5af78e>&#34;</span> <span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># if provisioning fails, print log to the terminal that&#39;s running the `az` command</span>
</span></span><span style=display:flex><span>cleanup<span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>  <span style=color:#ff5c57>ret</span><span style=color:#ff6ac1>=</span><span style=color:#ff5c57>$?</span>
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>if</span> <span style=color:#ff6ac1>[</span> <span style=color:#ff5c57>$ret</span> -ne <span style=color:#ff9f43>0</span> <span style=color:#ff6ac1>]</span>; <span style=color:#ff6ac1>then</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;Debug log:&#34;</span>
</span></span><span style=display:flex><span>    cat <span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff5c57>exit</span> <span style=color:#ff5c57>$ret</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>trap</span> cleanup EXIT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># make `apt` great again</span>
</span></span><span style=display:flex><span>cat <span style=color:#5af78e>&lt;&lt;EOF &gt; /etc/apt/sources.list
</span></span></span><span style=display:flex><span><span style=color:#5af78e>###### Ubuntu Main Repos
</span></span></span><span style=display:flex><span><span style=color:#5af78e>deb http://no.archive.ubuntu.com/ubuntu/ bionic main restricted universe multiverse
</span></span></span><span style=display:flex><span><span style=color:#5af78e>
</span></span></span><span style=display:flex><span><span style=color:#5af78e>###### Ubuntu Update Repos
</span></span></span><span style=display:flex><span><span style=color:#5af78e>deb http://no.archive.ubuntu.com/ubuntu/ bionic-security main restricted universe multiverse
</span></span></span><span style=display:flex><span><span style=color:#5af78e>deb http://no.archive.ubuntu.com/ubuntu/ bionic-updates main restricted universe multiverse
</span></span></span><span style=display:flex><span><span style=color:#5af78e>deb http://no.archive.ubuntu.com/ubuntu/ bionic-proposed main restricted universe multiverse
</span></span></span><span style=display:flex><span><span style=color:#5af78e>deb http://no.archive.ubuntu.com/ubuntu/ bionic-backports main restricted universe multiverse
</span></span></span><span style=display:flex><span><span style=color:#5af78e>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># install java and unzip</span>
</span></span><span style=display:flex><span>sudo apt update &gt;&gt;<span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>sudo apt -y install openjdk-11-jdk-headless unzip &gt;&gt;<span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># env vars</span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>export</span> <span style=color:#ff5c57>java_dir</span><span style=color:#ff6ac1>=</span>/usr/lib/jvm/java-11-openjdk-amd64
</span></span><span style=display:flex><span><span style=color:#ff5c57>export</span> <span style=color:#ff5c57>android_dir</span><span style=color:#ff6ac1>=</span>/home/AzDevOps/android-sdk
</span></span><span style=display:flex><span><span style=color:#ff5c57>export</span> <span style=color:#ff5c57>PATH</span><span style=color:#ff6ac1>=</span><span style=color:#ff5c57>$PATH</span>:<span style=color:#ff5c57>$android_dir</span>/cmdline-tools/latest
</span></span><span style=display:flex><span><span style=color:#ff5c57>export</span> <span style=color:#ff5c57>PATH</span><span style=color:#ff6ac1>=</span><span style=color:#ff5c57>$PATH</span>:<span style=color:#ff5c57>$android_dir</span>/cmdline-tools/latest/bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;android dir: </span><span style=color:#ff5c57>$android_dir</span><span style=color:#5af78e>&#34;</span> &gt;&gt;<span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># get and extract android command line tools</span>
</span></span><span style=display:flex><span>wget -O tools.zip https://dl.google.com/android/repository/commandlinetools-linux-8092744_latest.zip
</span></span><span style=display:flex><span>mkdir -p <span style=color:#ff5c57>$android_dir</span>/cmdline-tools
</span></span><span style=display:flex><span>unzip tools.zip -d <span style=color:#ff5c57>$android_dir</span>/cmdline-tools &gt;&gt;<span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># https://stackoverflow.com/questions/60440509/android-command-line-tools-sdkmanager-always-shows-warning-could-not-create-se</span>
</span></span><span style=display:flex><span>rm -rf <span style=color:#ff5c57>$android_dir</span>/cmdline-tools/latest
</span></span><span style=display:flex><span>mv <span style=color:#ff5c57>$android_dir</span>/cmdline-tools/cmdline-tools <span style=color:#ff5c57>$android_dir</span>/cmdline-tools/latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># install android SDK</span>
</span></span><span style=display:flex><span>yes | sdkmanager --licenses &gt;&gt;<span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sdkmanager <span style=color:#5af78e>&#34;emulator&#34;</span> <span style=color:#5af78e>&#34;tools&#34;</span> <span style=color:#5af78e>&#34;platform-tools&#34;</span>
</span></span><span style=display:flex><span>yes | sdkmanager <span style=color:#5af78e>\
</span></span></span><span style=display:flex><span><span style=color:#5af78e></span>  <span style=color:#5af78e>&#34;build-tools;31.0.0&#34;</span> &gt;&gt;<span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>yes | sdkmanager <span style=color:#5af78e>\
</span></span></span><span style=display:flex><span><span style=color:#5af78e></span>  <span style=color:#5af78e>&#34;extras;android;m2repository&#34;</span> <span style=color:#5af78e>\
</span></span></span><span style=display:flex><span><span style=color:#5af78e></span>  <span style=color:#5af78e>&#34;extras;google;m2repository&#34;</span> <span style=color:#5af78e>\
</span></span></span><span style=display:flex><span><span style=color:#5af78e></span>  <span style=color:#5af78e>&#34;extras;google;google_play_services&#34;</span> &gt;&gt;<span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>yes | sdkmanager <span style=color:#5af78e>\
</span></span></span><span style=display:flex><span><span style=color:#5af78e></span>  <span style=color:#5af78e>&#34;platforms;android-31&#34;</span> &gt;&gt;<span style=color:#ff5c57>$logFile</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;All is well.&#34;</span> &gt;&gt;<span style=color:#ff5c57>$logFile</span>
</span></span></code></pre></div><h2 id=and-then-just-like-that>And then, just like that
<a class=heading-link href=#and-then-just-like-that><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Change your <code>build.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>      jobs:
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>-</span> job: Build
</span></span><span style=display:flex><span><span style=color:#ff6ac1>-</span>     <span style=color:#ff6ac1>-</span> pool: <span style=color:#5af78e>&#39;macOS-latest&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>+</span>     <span style=color:#ff6ac1>-</span> pool: <span style=color:#5af78e>&#39;android-vmss-ephemeral&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#ff6ac1>...</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>+</span>       <span style=color:#ff6ac1>-</span> script: <span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>+</span>           sudo cat <span style=color:#ff6ac1>/</span><span style=color:#ff6ac1>var</span><span style=color:#ff6ac1>/</span><span style=color:#ff5c57>log</span><span style=color:#ff6ac1>/</span>debug
</span></span></code></pre></div><p><img src=new-build.png alt="new build"></p><p>I did have a beer. It was non-alcoholic.</p></div><footer></footer></article></section></div><style>form{display:flex;justify-content:center}</style><form action="https://api.follow.it/subscription-form/SDRVMUk2VmsySENBNk94RDNKNDFnS3NmWlQ5a3gxejNIeUlJWHl3QjdqNnRHdENkaXp5aXZhZlFvcGtzcEZ3K0o5TFVRdSt2WWM5RWRsWmZwWVhNUS9PZjJqMWZ3aHBwZUhjT1ZpWXBGRkdZOWtIcGhYQkJkSkE4QTQ1eHl5YkF8RTZHTExQOWFrN1pFY1F0RzZ5c3pVN2I1QTI1YXNtMjZiYllLU25zQkJ3bz0=/8" method=post onsubmit=onSubscribe()><input type=email name=email required placeholder=Email spellcheck=false style="padding:1rem;border:none;border-radius:1rem 0 0 1rem;outline:none">
<button type=submit style="border:none;border-radius:0 1rem 1rem 0;outline:none;background:rgba(127,127,127,5%);cursor:pointer">
Subscribe</button></form><div id=elm-widget></div><script src=/widget.js></script><script>Elm.Main.init({node:document.getElementById("elm-widget"),flags:window.location.pathname})</script><script type=text/javascript src="https://platform-api.sharethis.com/js/sharethis.js#property=6834b86198608700128c9ffa&product=sticky-share-buttons" async></script><footer class=footer><section class=container>Â© 2021 - 2025 Christian Ekrem
<script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-emoji=ðŸº data-id=cekrem data-description="Support me on Buy me a coffee!" data-message data-color=#ddd data-position=Left data-x_margin=18 data-y_margin=18></script></section><script src=https://formspree.io/js/formbutton-v1.min.js defer></script></footer><script src=https://sdk.feedback.one/v0/core.min.js data-project-id=019589e0-c6fb-7b80-b6ae-dffbfbb11f72 defer></script><script>!function(e,t){var n,s,o,i;t.__SV||window.posthog&&window.posthog.__loaded||(window.posthog=t,t._i=[],t.init=function(a,r,c){function d(e,t){var n=t.split(".");2==n.length&&(e=e[n[0]],t=n[1]),e[t]=function(){e.push([t].concat(Array.prototype.slice.call(arguments,0)))}}(n=e.createElement("script")).type="text/javascript",n.crossOrigin="anonymous",n.async=!0,n.src=r.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(i=e.getElementsByTagName("script")[0]).parentNode.insertBefore(n,i);var l=t;for(0[0]!==c?l=t[c]=[]:c="posthog",l.people=l.people||[],l.toString=function(e){var t="posthog";return"posthog"!==c&&(t+="."+c),e||(t+=" (stub)"),t},l.people.toString=function(){return l.toString(1)+".people (stub)"},o="init Rr Mr fi Or Ar ci Tr Cr capture Mi calculateEventProperties Lr register register_once register_for_session unregister unregister_for_session Hr getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty Ur jr createPersonProfile zr kr Br opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing Dr debug M Nr getPageViewId captureTraceFeedback captureTraceMetric $r".split(" "),s=0;s<o.length;s++)d(l,o[s]);t._i.push([a,r,c])},t.__SV=1)}(document,window.posthog||[]),posthog.init("phc_AHy7NSMntJJLr0hUSCwdUS1eRq6SaEqacK1Mzzf36ED",{api_host:"https://eu.i.posthog.com",defaults:"2025-05-24",person_profiles:"identified_only"});function onSubscribe(){posthog.capture("new subscriber")}</script></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script data-goatcounter=https://cekrem.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>